<!doctype html>
<html lang="en">
  <head>
    <!-- Required meta tags -->
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

    <!-- Bootstrap CSS -->
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/css/bootstrap.min.css" integrity="sha384-MCw98/SFnGE8fJT3GXwEOngsV7Zt27NXFoaoApmYm81iuXoPkFOJwJ8ERdknLPMO" crossorigin="anonymous">
    <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.4.1/css/all.css" integrity="sha384-5sAR7xN1Nv6T6+dT2mhtzEpVJvfS3NScPQTrOxhwjIuvcA67KV2R5Jz6kr4abQsz" crossorigin="anonymous">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.3.4/dist/leaflet.css"
      integrity="sha512-puBpdR0798OZvTTbP4A8Ix/l+A4dHDD0DGqYW6RQ+9jxkRFclaxxQb/SJAWZfWAkuyeQUytO7+7N4QKrDh+drA=="
      crossorigin=""/>

    <style media="screen">
      #map { height: 20em; max-width: 40em; margin: auto; }
      thead th { vertical-align: top !important; }
    </style>

    <title>Geolocation Demo</title>
  </head>
  <body>
    <main role="main" class="container">

      <h1>Geolocation Demo</h1>

      <button class="js-get-location btn btn-primary" type="button" name="button">
        <i class="fas fa-map-marker-alt"></i>
        Get Location
      </button>
      <button class="js-track-location btn btn-primary" type="button" name="button">
        <i class="fas fa-search-location"></i>
        Track Location
      </button>
      <button class="js-stop-tracking btn btn-outline-danger" style="display:none" type="button" name="button">
        <i class="fas fa-stop-circle"></i>
        Stop Tracking
      </button>
      <p class="text-muted" id="page-status">
        Initialising…
      </p>
      <div id="map"></div>
      <div class="table-responsive">
        <table class="table">
          <thead>
            <tr>
              <th>Delay</th>
              <th>Accuracy <small class="text-muted">(P=95%)</small></th>
              <th>Latitude</th>
              <th>Longitude</th>
            </tr>
          </thead>
          <tbody class="js-location-table">
          </tbody>
        </table>
      </div>
    </main><!-- /.container -->

    <!-- Optional JavaScript -->
    <!-- jQuery first, then Popper.js, then Bootstrap JS -->
    <script src="https://code.jquery.com/jquery-3.3.1.min.js" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.3/umd/popper.min.js" integrity="sha384-ZMP7rVo3mIykV+2+9J3UJ46jBk0WLaUAdn689aCwoqbBJiSnjAK/l8WvCWPIPm49" crossorigin="anonymous"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/js/bootstrap.min.js" integrity="sha384-ChfqqxuZUCnJSK3+MXmPNIyE6ZbWh2IMqE241rYiqJxyMiZ6OW/JmZQ5stwEULTy" crossorigin="anonymous"></script>
    <script src="https://unpkg.com/leaflet@1.3.4/dist/leaflet.js"
      integrity="sha512-nMMmRyTVoLYqjP9hrbed9S+FzjZHW5gY1TWCHA5ckwXZBadntCNs8kEqAWdrb9O7rxbCaA4lKTIWjDXZxflOcA=="
      crossorigin=""></script>


    <script type="text/javascript">
      var geolocationOpts = {
        enableHighAccuracy: true,
        timeout: 10000,
        maximumAge: 0
      };
      var mymap;
      var lastCircle;
      var watchId;

      function log(text) { $('#page-status').text(text); }

      function getLocation() {
        $('.js-get-location').attr('disabled', 'disabled');
        var startTime = new Date()
        navigator.geolocation.getCurrentPosition(
          function(position) {
            processLocation(position, startTime);
            log('Located.');
            $('.js-get-location').removeAttr('disabled');
          },
          handleLocationError,
          geolocationOpts
        );
        log('Locating…');
      }

      function trackLocation() {
        $('.js-get-location').attr('disabled', 'disabled');
        $('.js-track-location').hide();
        $('.js-stop-tracking').show();
        watchId = navigator.geolocation.watchPosition(
          function(position) {
            processLocation(position, null);
          },
          handleLocationError,
          geolocationOpts
        );
        log('Watching…');
      }

      function stopTrackingLocation() {
        $('.js-get-location').removeAttr('disabled');
        $('.js-track-location').show();
        $('.js-stop-tracking').hide();
        if (watchId) {
          navigator.geolocation.clearWatch(watchId);
          log('Ready.')
        }
      }

      function processLocation(position, startTime) {
        var delay = startTime ? (position.timestamp - startTime) / 1000 : 0;
        console.log(position);
        var $row = $(
          "<tr style='display:none'>" +
            // "<td><button class='btn btn-outline-primary js-map-coordinates'><i class='fas fa-map-marked-alt'></i></button></td>"+
            "<td>" + delay.toFixed(1) + " s</td>"+
            "<td>" + Math.round(position.coords.accuracy) + " m</td>"+
            "<td>" + position.coords.latitude + "</td>"+
            "<td>" + position.coords.longitude + "</td>"+
          "</tr>"
        ).prependTo('.js-location-table');
        // $row.data('coords', position.coords);
        $row.fadeIn()
        mapCoordinates(position.coords);
      }

      function handleLocationError(error) {
        console.log(error);
        log('Error getting location (' + error.message + ')');
      }

      function initialiseMap() {
        mymap = L.map('map');
        L.tileLayer('https://api.tiles.mapbox.com/v4/{id}/{z}/{x}/{y}.png?access_token={accessToken}', {
            attribution: 'Map data &copy; <a href="https://www.openstreetmap.org/">OpenStreetMap</a> contributors, <a href="https://creativecommons.org/licenses/by-sa/2.0/">CC-BY-SA</a>, Imagery © <a href="https://www.mapbox.com/">Mapbox</a>',
            maxZoom: 18,
            id: 'mapbox.satellite',
            accessToken: 'pk.eyJ1IjoiZGFuaWVsZm9uZSIsImEiOiJjam5wNG1zMXoxYWtpM3dueHo5bWNpMng1In0.KcFYPss4RkOudvf-fNMs0g'
        }).addTo(mymap);
      }

      function mapCoordinates(coords) {
        if (lastCircle) lastCircle.remove();
        var bounds = L.latLng(coords.latitude, coords.longitude).toBounds(coords.accuracy * 2);
        mymap.fitBounds(bounds, {padding: [10, 10]});
        lastCircle = L.circle([coords.latitude, coords.longitude], {
            color: 'blue',
            fillColor: '#03f',
            fillOpacity: 0.25,
            radius: coords.accuracy
        }).addTo(mymap);
      }

      jQuery(function($){
        initialiseMap();
        $('.js-get-location').click(getLocation);
        $('.js-track-location').click(trackLocation);
        $('.js-stop-tracking').click(stopTrackingLocation);
        $('.js-map-coordinates').click(function(){
          // mapCoordinates($(this).closest('tr').data('coords'))
        })
        log('Ready.')
      })
    </script>
  </body>
</html>
